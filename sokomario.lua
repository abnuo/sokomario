levels = {
"    #####n    #   #n    #$  #n  ###  $##n  #  $ $ #n### # ## #   ######n#   # ## #####  ..#n# $  $          ..#n##### ### #@##  ..#n    #     #########n    #######",
"############n#..  #     ###n#..  # $  $  #n#..  #$####  #n#..    @ ##  #n#..  # #  $ ##n###### ##$ $ #n  # $  $ $ $ #n  #    #     #n  ############",
"        ########n        #     @#n        # $#$ ##n        # $  $#n        ##$ $ #n######### $ # ###n#....  ## $  $  #n##...    $  $   #n#....  ##########n########",
"           ########n           #  ....#n############  ....#n#    #  $ $   ....#n# $$$#$  $ #  ....#n#  $     $ #  ....#n# $$ #$ $ $########n#  $ #     #n## #########n#    #    ##n#     $   ##n#  $$#$$  @#n#    #    ##n###########",
"        #####n        #   #####n        # #$##  #n        #     $ #n######### ###   #n#....  ## $  $###n#....    $ $$ ##n#....  ##$  $ @#n#########  $  ##n        # $ $  #n        ### ## #n          #    #n          ######",
"######  ###n#..  # ##@##n#..  ###   #n#..     $$ #n#..  # # $ #n#..### # $ #n#### $ #$  #n   #  $# $ #n   # $  $  #n   #  ##   #n   #########",
"       #####n #######   ##n## # @## $$ #n#    $      #n#  $  ###   #n### #####$###n# $  ### ..#n# $ $ $ ...#n#    ###...#n# $$ # #...#n#  ### #####n####",
"  ####n  #  ###########n  #    $   $ $ #n  # $# $ #  $  #n  #  $ $  #    #n### $# #  #### #n#@#$ $ $  ##   #n#    $ #$#   # #n#   $    $ $ $ #n#####  #########n  #      #n  #      #n  #......#n  #......#n  #......#n  ########",
"          #######n          #  ...#n      #####  ...#n      #      . .#n      #  ##  ...#n      ## ##  ...#n     ### ########n     # $$$ ##n #####  $ $ #####n##   #$ $   #   #n#@ $  $    $  $ #n###### $$ $ #####n     #      #n     ########",
" ###  #############n##@####       #   #n# $$   $$  $ $ ...#n#  $$$#    $  #...#n# $   # $$ $$ #...#n###   #  $    #...#n#     # $ $ $ #...#n#    ###### ###...#n## #  #  $ $  #...#n#  ## # $$ $ $##..#n# ..# #  $      #.#n# ..# # $$$ $$$ #.#n##### #       # #.#n    # ######### #.#n    #           #.#n    ###############",
"          ####n     #### #  #n   ### @###$ #n  ##      $  #n ##  $ $$## ##n #  #$##     #n # # $ $$ # ###n #   $ #  # $ #####n####    #  $$ #   #n#### ## $         #n#.    ###  ########n#.. ..# ####n#...#.#n#.....#n#######",
"################n#              #n# # ######     #n# #  $ $ $ $#  #n# #   $@$   ## ##n# #  $ $ $###...#n# #   $ $  ##...#n# ###$$$ $ ##...#n#     # ## ##...#n#####   ## ##...#n    #####     ###n        #     #n        #######",
"   #########n  ##   ##  #####n###     #  #    ###n#  $ #$ #  #  ... #n# # $#@$## # #.#. #n#  # #$  #    . . #n# $    $ # # #.#. #n#   ##  ##$ $ . . #n# $ #   #  #$#.#. #n## $  $   $  $... #n #$ ######    ##  #n #  #    ##########n ####",
"       #######n #######     #n #     # $@$ #n #$$ #   #########n # ###......##   #n #   $......## # #n # ###......     #n##   #### ### #$##n#  #$   #  $  # #n#  $ $$$  # $## #n#   $ $ ###$$ # #n#####     $   # #n    ### ###   # #n      #     #   #n      ########  #n             ####",
"   ########n   #   #  #n   #  $   #n ### #$   ####n #  $  ##$   #n #  # @ $ # $#n #  #      $ ####n ## ####$##     #n # $#.....# #   #n #  $..**. $# ###n##  #.....#   #n#   ### #######n# $$  #  #n#  #     #n######   #n     #####",
"#####n#   ##n#    #  ####n# $  ####  #n#  $$ $   $#n###@ #$    ##n #  ##  $ $ ##n # $  ## ## .#n #  #$##$  #.#n ###   $..##.#n  #    #.*...#n  # $$ #.....#n  #  #########n  #  #n  ####",
"   ##########n   #..  #   #n   #..      #n   #..  #  ####n  #######  #  ##n  #            #n  #  #  ##  #  #n#### ##  #### ##n#  $  ##### #  #n# # $  $  # $  #n# @$  $   #   ##n#### ## #######n   #    #n   ######",
"     ###########n     #  .  #   #n     # #.    @ #n ##### ##..# ####n##  # ..###     ###n# $ #...   $ #  $ #n#    .. ##  ## ## #n####$##$# $ #   # #n  ## #    #$ $$ # #n  #  $ # #  # $## #n  #               #n  #  ###########  #n  ####         ####",
"  ######n  #   @####n##### $   #n#   ##    ####n# $ #  ##    #n# $ #  ##### #n## $  $    # #n## $ $ ### # #n## #  $  # # #n## # #$#   # #n## ###   # # ######n#  $  #### # #....#n#    $    $   ..#.#n####$  $# $   ....#n#       #  ## ....#n###################",
"    ##########n#####        ####n#     #   $  #@ #n# #######$####  ###n# #    ## #  #$ ..#n# # $     #  #  #.#n# # $  #     #$ ..#n# #  ### ##     #.#n# ###  #  #  #$ ..#n# #    #  ####  #.#n# #$   $  $  #$ ..#n#    $ # $ $ #  #.#n#### $###    #$ ..#n   #    $$ ###....#n   #      ## ######n   ########",
"#########n#       #n#       ####n## #### #  #n## #@##    #n# $$$ $  $$#n#  # ## $  #n#  # ##  $ ####n####  $$$ $#  #n #   ##   ....#n # #   # #.. .#n #   # # ##...#n ##### $  #...#n     ##   #####n      #####",
"######     ####n#    #######  #####n#   $#  #  $  #   #n#  $  $  $ # $ $  #n##$ $   # @# $    #n#  $ ########### ##n# #   #.......# $#n# ##  # ......#  #n# #   $........$ #n# # $ #.... ..#  #n#  $ $####$#### $#n# $   ### $   $  ##n# $     $ $  $    #n## ###### $ ##### #n#         #       #n###################",
"    #######n    #  #  ####n##### $#$ #  ##n#.. #  #  #   #n#.. # $#$ #  $####n#.  #     #$  #  #n#..   $#  # $    #n#..@#  #$ #$  #  #n#.. # $#     $#  #n#.. #  #$$#$  #  ##n#.. # $#  #  $#$  #n#.. #  #  #   #   #n##. ####  #####   #n ####  ####   #####",
"###############n#..........  .####n#..........$$.#  #n###########$ #   ##n#      $  $     $ #n## ####   #  $ #  #n#      #   ##  # ##n#  $#  # ##  ### ##n# $ #$###    ### ##n###  $ #  #  ### ##n###    $ ## #  # ##n # $  #  $  $ $   #n #  $  $#$$$  #   #n #  #  $      #####n # @##  #  #  #n ##############",
"####n#  ##############n#  #   ..#......#n#  # # ##### ...#n##$#    ........#n#   ##$######  ####n# $ #     ######@ #n##$ # $   ######  #n#  $ #$$$##       #n#      #    #$#$###n# #### #$$$$$    #n# #    $     #   #n# #   ##        ###n# ######$###### $ #n#        #    #   #n##########    #####",
" #######n #  #  #####n##  #  #...###n#  $#  #...  #n# $ #$$ ...  #n#  $#  #... .#n#   # $########n##$       $ $ #n##  #  $$ #   #n ######  ##$$@#n      #      ##n      ########",
" #################n #...   #    #   ##n##.....  $## # #$ #n#......#  $  #    #n#......#  #  # #  #n######### $  $ $  #n  #     #$##$ ##$##n ##   $    # $    #n #  ## ### #  ##$ #n # $ $$     $  $  #n # $    $##$ ######n #######  @ ##n       ######",
"         #####n     #####   #n    ## $  $  ####n##### $  $ $ ##.#n#       $$  ##..#n#  ###### ###.. #n## #  #    #... #n# $   #    #... #n#@ #$ ## ####...#n####  $ $$  ##..#n   ##  $ $  $...#n    # $$  $ #  .#n    #   $ $  ####n    ######   #n         #####",
"#####n#   ##n# $  #########n## # #       ######n## #   $#$#@  #   #n#  #      $ #   $ #n#  ### ######### ##n#  ## ..*..... # ##n## ## *.*..*.* # ##n# $########## ##$ #n#  $   $  $    $  #n#  #   #   #   #  #n###################",
"       ###########n       #   #     #n#####  #     $ $ #n#   ##### $## # ##n# $ ##   # ## $  #n# $  @$$ # ##$$$ #n## ###   # ##    #n## #   ### #####$#n## #     $  #....#n#  ### ## $ #....##n# $   $ #   #..$. #n#  ## $ #  ##.... #n#####   ######...##n    #####    #####",
"  ####n  #  #########n ##  ##  #   #n #  $# $@$   ####n #$  $  # $ $#  ##n##  $## #$ $     #n#  #  # #   $$$  #n# $    $  $## ####n# $ $ #$#  #  #n##  ###  ###$ #n #  #....     #n ####......####n   #....####n   #...##n   #...#n   #####",
"      ####n  #####  #n ##     $#n## $  ## ###n#@$ $ # $  #n#### ##   $#n #....#$ $ #n #....#   $#n #....  $$ ##n #... # $   #n ######$ $  #n      #   ###n      #$ ###n      #  #n      ####",
"############n##     ##  #n##   $   $ #n#### ## $$ #n#   $ #    #n# $$$ # ####n#   # # $ ##n#  #  #  $ #n# $# $#    #n#   ..# ####n####.. $ #@#n#.....# $# #n##....#  $ #n###..##    #n############",
" #########n #....   ##n #.#.#  $ ##n##....# # @##n# ....#  #  ##n#     #$ ##$ #n## ###  $    #n #$  $ $ $#  #n # #  $ $ ## #n #  ###  ##  #n #    ## ## ##n #  $ #  $  #n ###$ $   ###n   #  #####n   ####",
"############ ######n#   #    # ###....#n#   $$#   @  .....#n#   # ###   # ....#n## ## ###  #  ....#n # $ $     # # ####n #  $ $##  #      #n#### #  #### # ## #n#  # #$   ## #    #n# $  $  # ## #   ##n# # $ $    # #   #n#  $ ## ## # #####n# $$     $$  #n## ## ### $  #n #    # #    #n ###### ######",
"            #####n#####  ######   #n#   ####  $ $ $ #n# $   ## ## ##  ##n#   $ $     $  $ #n### $  ## ##     ##n  # ##### #####$$ #n ##$##### @##     #n # $  ###$### $  ##n # $  #   ###  ###n # $$ $ #   $$ #n #     #   ##  #n #######.. .###n    #.........#n    #.........#n    ###########",
"###########n#......   #########n#......   #  ##   #n#..### $    $     #n#... $ $ #   ##   #n#...#$#####    #  #n###    #   #$  #$ #n  #  $$ $ $  $##  #n  #  $   #$#$ ##$ #n  ### ## #    ##  #n   #  $ $ ## ######n   #    $  $  #n   ##   # #   #n    #####@#####n        ###",
"      ####n####### @#n#     $  #n#   $## $#n##$#...# #n # $...  #n # #. .# ##n #   # #$ #n #$  $    #n #  #######n ####",
"             ######n #############....#n##   ##     ##....#n#  $$##  $ @##....#n#      $$ $#  ....#n#  $ ## $$ # # ...#n#  $ ## $  #  ....#n## ##### ### ##.###n##   $  $ ##   .  #n# $###  # ##### ###n#   $   #       #n#  $ #$ $ $###  #n# $$$# $   # ####n#    #  $$ #n######   ###n     #####",
"    ############n    #          ##n    #  # #$$ $  #n    #$ #$#  ## @#n   ## ## # $ # ##n   #   $ #$  # #n   #   # $   # #n   ## $ $   ## #n   #  #  ##  $ #n   #    ## $$# #n######$$   #   #n#....#  ########n#.#... ##n#....   #n#....   #n#########",
"           #####n          ##   ##n         ##     #n        ##  $$  #n       ## $$  $ #n       # $    $ #n####   #   $$ #####n#  ######## ##    #n#.            $$$@#n#.# ####### ##   ##n#.# #######. #$ $##n#........... #    #n##############  $ #n             ##  ##n              ####",
"     ########n  ####      ######n  #    ## $ $   @#n  # ## ##$#$ $ $##n### ......#  $$ ##n#   ......#  #   #n# # ......#$  $  #n# #$...... $$# $ #n#   ### ###$  $ ##n###  $  $  $  $ #n  #  $  $  $  $ #n  ######   ######n       #####",
"        #######n    #####  #  ####n    #   #   $    #n #### #$$ ## ##  #n##      # #  ## ###n#  ### $#$  $  $  #n#...    # ##  #   #n#...#    @ # ### ##n#...#  ###  $  $  #n######## ##   #   #n          #########",
" #####n #   #n # # #######n #      $@######n # $ ##$ ###   #n # #### $    $ #n # ##### #  #$ ####n##  #### ##$      #n#  $#  $  # ## ## #n#         # #...# #n######  ###  ...  #n     #### # #...# #n          # ### # #n          #       #n          #########",
"##### ####n#...# #  ####n#...###  $  #n#....## $  $###n##....##   $  #n###... ## $ $ #n# ##    #  $  #n#  ## # ### ####n# $ # #$  $    #n#  $ @ $    $  #n#   # $ $$ $ ###n#  ######  ###n# ##    ####n###",
"##########n#        ####n# ###### #  ##n# # $ $ $  $ #n#       #$   #n###$  $$#  ###n  #  ## # $##n  ##$#   $ @#n   #  $ $ ###n   # #   $  #n   # ##   # #n  ##  ##### #n  #         #n  #.......###n  #.......#n  #########",
"         ####n #########  ##n##  $      $ #####n#   ## ##   ##...#n# #$$ $ $$#$##...#n# #   @   #   ...#n#  $# ###$$   ...#n# $  $$  $ ##....#n###$       #######n  #  #######n  ####",
"  #########  n  #*.*#*.*#  n  #.*.*.*.#  n  #*.*.*.*#  n  #.*.*.*.#  n  #*.*.*.*#  n  ###   ###  n    #   #    n###### ######n#           #n# $ $ $ $ $ #n## $ $ $ $ ##n #$ $ $ $ $# n #   $@$   # n #  #####  # n ####   ####",
"       ####n       #  ##n       #   ##n       # $$ ##n     ###$  $ ##n  ####    $   #n###  # #####  #n#    # #....$ #n# #   $ ....# #n#  $ # #.*..# #n###  #### ### #n  #### @$  ##$##n     ### $     #n       #  ##   #n       ######### ",
"      ############n     ##..    #   #n    ##..* $    $ #n   ##..*.# # # $##n   #..*.# # # $  #n####...#  #    # #n#  ## #          #n# @$ $ ###  #   ##n# $   $   # #   #n###$$   # # # # #n  #   $   # # #####n  # $# #####      #n  #$   #   #    # #n  #  ###   ##     #n  #  #      #    ##n  ####      ######",
}
timer = 0
tile_floor = 0x24
tile_player = 0x33
tile_player_docked = 0x34
tile_box = 0xcf
tile_box_docked = 0xce
tile_wall = 0x47
tile_dock = 0x29
charmap = {
[" "] = tile_floor,
["@"] = tile_player,
["+"] = tile_player_docked,
["$"] = tile_box,
["*"] = tile_box_docked,
["#"] = tile_wall,
["."] = tile_dock,
}
level = 1
boxesin = 0
boxesrequired = 0
px = 0
py = 0
function set_tile(x,y,c)
  emu.write(0x2000+(y*32+x),c,emu.memType.ppu)
end
function get_tile(x,y)
  return emu.read(0x2000+(y*32+x),emu.memType.ppu)
end
function clear_screen()
  for y=0,29 do
    for x=0,31 do
      set_tile(x,y,0x24)
    end
  end
end
function loadlevel(n)
  local data = levels[n]
  local x = 1
  local y = 1
  boxesrequired = 0
  boxesin = 0
  clear_screen()
  for i=1,#data do
    local char = string.sub(data,i,i)
    if (char == "n") then
      x = 1
      y = y+1
    else
      if (char == "@") or (char == "+") then
        px = x-1
        py = y-1
      end
      if (char == ".") then
        boxesrequired = boxesrequired+1
      end
      set_tile(x-1,y-1,charmap[char])
      x = x+1
    end
  end
end
function move(x,y,ox,oy,collide,change,leave)
  local tile = get_tile(x,y)
  if (change == 0) then
    change = tile
  end
  if (collide == true) then
    if (get_tile(x+ox,y+oy) == tile_wall) or (get_tile(x+ox,y+oy) == tile_box) or (get_tile(x+ox,y+oy) == tile_box_docked) then
      return false
    else
      set_tile(x,y,leave)
      set_tile(x+ox,y+oy,change)
      return true
    end
    else
      set_tile(x,y,leave)
      set_tile(x+ox,y+oy,change)
      return true
  end
end
function movebox(x,y,ox,oy)
  local change = 0
  local leave = tile_floor
  if (get_tile(x+ox,y+oy) == tile_dock) then
    change = tile_box_docked
  end
  if (get_tile(x+ox,y+oy) == tile_dock) and (get_tile(x,y) == tile_box) then
    boxesin = boxesin+1
  end
  if (get_tile(x+ox,y+oy) == tile_floor) then
    change = tile_box
  end
  if (get_tile(x+ox,y+oy) == tile_floor) and (get_tile(x,y) == tile_box_docked) then
    if (boxesin > 0) then
      boxesin = boxesin-1
    end
  end
  if (get_tile(x,y) == tile_box_docked) then
    leave = tile_dock
  end
  move(x,y,ox,oy,true,change,leave)
end
function moveplayer(ox,oy)
  local change = 0
  local leave = tile_floor
  if (get_tile(px+ox,py+oy) == tile_dock) then
    change = tile_player_docked
  end
  if (get_tile(px+ox,py+oy) == tile_floor) then
    change = tile_player
  end
  if (get_tile(px,py) == tile_player_docked) then
    leave = tile_dock
  end
  if (get_tile(px+ox,py+oy) == tile_box_docked) then
    change = tile_player_docked
  end
  if (get_tile(px+ox,py+oy) == tile_box) then
    change = tile_player
  end
  if (get_tile(px+ox,py+oy) == tile_box) or (get_tile(px+ox,py+oy) == tile_box_docked) then
    movebox(px+ox,py+oy,ox,oy)
  end
  local r = move(px,py,ox,oy,true,change,leave)
  if (r == true) then
    px = px+ox
    py = py+oy
  end
end
function resetdemo()
  -- Ensure the game will never enter demo mode
  emu.write(0x07a2,0xff,emu.memType.cpu)
end
function handle()
  if (timer%9 == 0) then
    local stop = timer+2
    local inp = emu.getInput(0)
    if inp.start then
      loadlevel(level)
    end
    if inp.up then
      moveplayer(0,-1)
    end
    if inp.down then
      moveplayer(0,1)
    end
    if inp.left then
      moveplayer(-1,0)
    end
    if inp.right then
      moveplayer(1,0)
    end
  end
end
function main()
  resetdemo()
  handle()
  if (boxesin == boxesrequired) then
    clear_screen()
    level = level+1
    loadlevel(level)
  end
  timer = timer+1
end
-- Copy marios head
for i=0,16 do
  d = emu.read(0x0330+i,emu.memType.ppuDebug)
  emu.write(0x1330+i,d,emu.memType.ppuDebug)
end
for i=0,0x3ff do
  emu.write(0x2000+i,0x55,emu.memType.ppuDebug)
end
emu.addEventCallback(main,emu.eventType.startFrame)
loadlevel(level)